//DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers with GeoServer WMS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v7.1.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v7.1.0/dist/ol.js"></script>
    <style>
        .map {
            height: 750px;
            width: 100%;
        }

        .toutes-selections{
            display:flex;
            flex-direction: row;
        }

        .selection{
            margin-left: 30px;
            margin-right: 30px;
        }

    </style>
</head>
<body>
<div id="map" class="map"></div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        var geoserver = 'http://localhost:8080/geoserver/toto/wms';
        var geoserver_vector = 'http://localhost:8080/geoserver/toto/';



        function polygonStyleFunction(feature, resolution) {
            return new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'black',
                    width: 3,
                }),
                text: new ol.style.Text({
                    text: feature.get('name'),
                    stroke : new ol.style.Stroke({color: 'black', width : 1})
                }),
            });
        }

        var serviceStyle = new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(255, 0, 0, 0.5)' // Couleur de remplissage
            }),
            stroke: new ol.style.Stroke({
                color: 'red', // Couleur de la bordure
                width: 2 // Largeur de la bordure
            })
        });

        // Définir un style pour les bâtiments (polygones)
        var batimentStyle = new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(0, 0, 255, 0.5)' // Couleur de remplissage
            }),
            stroke: new ol.style.Stroke({
                color: 'blue', // Couleur de la bordure
                width: 2 // Largeur de la bordure
            })
        });

        // Définir un style pour les transports (points et lignes)
        var transportStyle = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({
                    color: 'green' // Couleur de remplissage du cercle
                })
            }),
            stroke: new ol.style.Stroke({
                color: 'green', // Couleur de la bordure
                width: 2 // Largeur de la bordure
            })
        });

        // Définir un style pour les résidences (polygones et points)
        var residenceStyle = new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(125, 125, 0, 0.5)' // Couleur de remplissage  juste plus le jaune pitié
            }),
            stroke: new ol.style.Stroke({
                color: 'green', // Couleur de la bordure
                width: 2 // Largeur de la bordure
            }),
            image: new ol.style.Circle({
                radius: 5,
                fill: new ol.style.Fill({
                    color: 'green' // Couleur de remplissage du cercle
                })
            })
        });

        // Définir un style pour les cafétérias (points et polygones)
        var cafetStyle = new ol.style.Style({
            fill: new ol.style.Fill({
                color: 'rgba(128, 0, 128, 0.5)' // Couleur de remplissage
            }),
            stroke: new ol.style.Stroke({
                color: 'purple', // Couleur de la bordure
                width: 2 // Largeur de la bordure
            }),
            image: new ol.style.Icon({
                src: 'lien_vers_votre_logo_pour_cafeteria.png', // Chemin vers votre logo
                anchor: [0.5, 1], // Ancre du logo (centre en bas)
                scale: 0.5 // Échelle du logo
            })
        });

        /// --> configuration des sources pour chaque couche.

        var batimentSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
                return (
                    'http://localhost:8080/geoserver/toto/' +
                    'ows?service=WFS&version=1.0.0' +
                    '&request=GetFeature&typeName=toto:map_batiment' +
                    '&outputFormat=application/json' +
                    '&srsname=EPSG:3857' +
                    '&bbox=' +
                    extent.join(',') +
                    ',EPSG:3857'
                );
            },
            strategy: ol.loadingstrategy.bbox
        });

        var serviceSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
                return (
                    'http://localhost:8080/geoserver/toto/' +
                    'ows?service=WFS&version=1.0.0' +
                    '&request=GetFeature&typeName=toto:map_services' +
                    '&outputFormat=application/json' +
                    '&srsname=EPSG:3857' +
                    '&bbox=' +
                    extent.join(',') +
                    ',EPSG:3857'
                );
            },
            strategy: ol.loadingstrategy.bbox
        });

        var cafetSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
                return (
                    'http://localhost:8080/geoserver/toto/' +
                    'ows?service=WFS&version=1.0.0' +
                    '&request=GetFeature&typeName=toto:map_cafet' +
                    '&outputFormat=application/json' +
                    '&srsname=EPSG:3857' +
                    '&bbox=' +
                    extent.join(',') +
                    ',EPSG:3857'
                );
            },
            strategy: ol.loadingstrategy.bbox
        });

        var residenceSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
                return (
                    'http://localhost:8080/geoserver/toto/' +
                    'ows?service=WFS&version=1.0.0' +
                    '&request=GetFeature&typeName=toto:map_residence' +
                    '&outputFormat=application/json' +
                    '&srsname=EPSG:3857' +
                    '&bbox=' +
                    extent.join(',') +
                    ',EPSG:3857'
                );
            },
            strategy: ol.loadingstrategy.bbox
        });

        var transportSource = new ol.source.Vector({
            format: new ol.format.GeoJSON(),
            url: function(extent) {
                return (
                    'http://localhost:8080/geoserver/toto/' +
                    'ows?service=WFS&version=1.0.0' +
                    '&request=GetFeature&typeName=toto:map_transports' +
                    '&outputFormat=application/json' +
                    '&srsname=EPSG:3857' +
                    '&bbox=' +
                    extent.join(',') +
                    ',EPSG:3857'
                );
            },
            strategy: ol.loadingstrategy.bbox
        });



        /// --> récupération des features //-----------------------------------------------------------

        ///  --------------------------- TEST-----------------------------

        /*var formSelectServices = document.getElementById('select-filiere');

        serviceSource.on('change', function(event){
            while (formSelectServices.firstChild){
                formSelectServices.removeChild(formSelectServices.firstChild)
            }
            serviceSource.getFeatures().forEach(function(f){



                console.log('name =' +  f.get('name'));
                var name = f.get('name');
                var option = document.createElement("option");

                option.textContent = name;
                option.value = name;

                formSelectServices.add(option);
            })
        });
        */


        ///  --------------------------- TEST-----------------------------

        /// --> configuration des layers //------------------------------------------------------------

        var batLayer = new ol.layer.Vector({
            source: batimentSource,
            style: batimentStyle
        });

        var residenceLayer = new ol.layer.Vector({
            source: residenceSource,
            style: residenceStyle
        });

        var cafetLayer = new ol.layer.Vector({
            source: cafetSource,
            style: cafetStyle
        });

        var serviceLayer = new ol.layer.Vector({
            source: serviceSource,
            style: serviceStyle
        });

        var transportsLayer = new ol.layer.Vector({
            source: transportSource,
            style: transportStyle
        });

        var map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                }),
                batLayer,
                transportsLayer,
                residenceLayer,
                serviceLayer,
                cafetLayer
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([1.934479273569592, 47.8437736162175]),
                zoom: 16
            })
        });

        var layers = {batLayer, cafetLayer, residenceLayer, transportsLayer, serviceLayer};
        var sources = {batimentSource, cafetSource, residenceSource, transportSource, serviceSource};
        var styles = {batimentStyle, cafetStyle, residenceStyle, transportStyle, serviceStyle}

        window.styles = styles;
        window.layers = layers;
        window.sources = sources;
        window.map = map; //pas nécessaire pour le moment
    });

    //-- Affichage des couches selon les checkboxs selectionnées dans la première colonne de choix -->
    function afficherItems() {
        var nomCouches = Array.from(document.querySelectorAll('.layer-checkbox:checked')).map(checkbox => checkbox.value);

        for (var nomCouche in window.layers) {
            var couche = window.layers[nomCouche];
            couche.setVisible(nomCouches.includes(nomCouche));
        }
    }

    //-- Selection de toutes les checkboxs de la colonne de gauche -->
    function selectAll() {
        Object.values(window.layers).forEach(function (couche) {
            couche.setVisible(true);
        }),
            document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
    }

    //-- Décoche toutes les checkboxs et enlève toutes les couches -->
    function resetCouches() {
        Object.values(window.layers).forEach(function (couche) {
            couche.setVisible(false);
        }),
            document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
    }

    //-- Changer l'affichage selon si prof ou étudiant -->
    function changePublic(option) {
        var checkboxes = document.querySelectorAll('.public-checkbox');
        checkboxes.forEach(function (checkbox) {
            if (checkbox.value !== option) {
                checkbox.checked = false;
            }
        });

        /*for (var nomCouche in window.layers) {
            var couche = window.layers[nomCouche];
            couche.setVisible(false);
        }*/

        var checked = Array.from(document.querySelectorAll('.public-checkbox:checked')).map(checkbox => checkbox.value);
        console.log(checked);

        var cafets = window.layers['cafetLayer'];
        var transports = window.layers['transportsLayer'];
        var residences = window.layers['residenceLayer'];

        if (checked.includes('etudiant')) {
            cafets.setVisible(true);
            transports.setVisible(true);
            residences.setVisible(true);
        }

        if (checked.includes('professeur')) {
            cafets.setVisible(true);
            transports.setVisible(true);
        }
    }

    function changeFiliere() {
        var serviceSelected = document.getElementById('select-filiere').value;

        var batsource = window.sources['batimentSource'];
        var featuresToFilter = (batsource.getFeatures());

        featuresToFilter.forEach(function (f){
            if (serviceSelected !== f.get('service_id')){
                f.setStyle(new ol.style.Style({}));
            }
            else{
                f.setStyle(window.styles['batimentStyle'])
            }
        });
    }

    function changeCampus() {
        var campusSelected = document.getElementById('select-campus').value;

        var batsource = window.sources['batimentSource'];
        var cafetsource = window.sources['cafetSource'];
        var transportsource = window.sources['transportSource'];
        var residencesource = window.sources['residenceSource'];
        var servsource = window.sources['serviceSource'];

        var allsources = [batsource, cafetsource, transportsource, residencesource, servsource];

        allsources.forEach(function (source) {
            source.getFeatures().forEach(function (feature) {
                if (campusSelected !== feature.get('campus')) {
                    console.log("ouais ici");
                    feature.setStyle(new ol.style.Style({}));
                }
                else {
                    feature.setStyle(window.styles['batimentStyle'])
                    //Style à changer en fonction du type de feature
                }
            });
        });
        deplaceCam(campusSelected);
        miseAjourSelect(campusSelected);
    }

    function miseAjourSelect(campusSelected){
      var formSelectServices = document.getElementById('select-filiere');
      while (formSelectServices.firstChild){
        formSelectServices.removeChild(formSelectServices.firstChild)
      }
      serviceSource = window.sources['serviceSource'];
        serviceSource.getFeatures().forEach(function(f){
          console.log('name =' +  f.get('name'));
            if (f.get('campus') === campusSelected){
              var name = f.get('name');
              var option = document.createElement("option");
              option.textContent = name;
              option.value = name;
              formSelectServices.add(option);
            }
        });
    }

    function deplaceCam(location) {
        console.log("oeoeoeoeoeoeoeoeoe");
        var center = null;
        switch (location) {
          case 'Orleans':
            center = ol.proj.fromLonLat([1.934479273569592, 47.8437736162175]);
            break;
          case 'Tours':
            center = ol.proj.fromLonLat([0.7035078916595157, 47.356139027711336])
        }
        window.map.getView().setCenter(center);
      }

    function exportGeojson(){
      var batsource = window.sources['batimentSource'];
      var cafetsource = window.sources['cafetSource'];
      var transportsource = window.sources['transportSource'];
      var residencesource = window.sources['residenceSource'];
      var servsource = window.sources['serviceSource'];

      var allsources = [batsource, cafetsource, transportsource, residencesource, servsource];

      const format = new ol.format.GeoJSON({featureProjection: 'EPSG:3857'});
      const download = document.getElementById('download');
      var features = [];
      
      allsources.forEach(function(source){
        source.getFeatures().forEach(function(f){
          features.push(f)
        });
      });
      const geojsonStr = format.writeFeatures(features);
      const blob = new Blob([geojsonStr], { type: 'application/json' });
      const downloadLink = document.createElement('a');

      downloadLink.href = URL.createObjectURL(blob);
      downloadLink.download = 'exported_data.geojson';

      // Append the link to the document
      document.body.appendChild(downloadLink);

      // Programmatically click on the link to trigger the download
      downloadLink.click();

      // Remove the link from the document
      document.body.removeChild(downloadLink);
    }

    function exportCsv() {
  var batsource = window.sources['batimentSource'];
  var cafetsource = window.sources['cafetSource'];
  var transportsource = window.sources['transportSource'];
  var residencesource = window.sources['residenceSource'];
  var servsource = window.sources['serviceSource'];

  var allsources = [batsource, cafetsource, transportsource, residencesource, servsource];

  // Create a CSV string with headers
  var csv = 'ID,Name,Geometry\n';

  allsources.forEach(function (source) {
    source.getFeatures().forEach(function (feature) {
      var name = feature.get('name');
      var description = feature.get('description');
      var geometryType = feature.getGeometry().getType();
      var geometry = JSON.stringify(format.writeGeometry(feature.getGeometry()));

      // Add a line for each feature
      csv += name + ',' + description + ',' + geometry + '\n';
    });
  });

  const blob = new Blob([csv], { type: 'text/csv' });
  const downloadLink = document.createElement('a');

  downloadLink.href = URL.createObjectURL(blob);
  downloadLink.download = 'exported_data.csv';

  // Append the link to the document
  document.body.appendChild(downloadLink);

  // Programmatically click on the link to trigger the download
  downloadLink.click();

  // Remove the link from the document
  document.body.removeChild(downloadLink);
}
    

    //-- Récupérer les informations de tous les formulaires et toutes les checkboxs -->
    // TODO : commencer par les campus
    // TODO : faire la sélection



    //-- Actions effectuées au lancement de l'application. On décoche toutes les checkboxs (pour l'instant y'a juste ça -->
    window.onload = function () {
        
        document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        }),
            document.getElementById('select-filiere').value = "";
            document.getElementById('select-campus').value = "";
        document.querySelectorAll('.public-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    };


</script>

<br><br>

<div class="toutes-selections">
    <div class="selection">
        <input type="checkbox" class="layer-checkbox" value="batLayer" onchange="afficherItems()">Batiments d'enseignement<br>
        <input type="checkbox" class="layer-checkbox" value="cafetLayer" onchange="afficherItems()">Restaurants et caféterias<br>
        <input type="checkbox" class="layer-checkbox" value="residenceLayer" onchange="afficherItems()">Résidences étudiantes<br>
        <input type="checkbox" class="layer-checkbox" value="transportsLayer" onchange="afficherItems()">Transports en commun<br>
        <input type="checkbox" class="layer-checkbox" value="serviceLayer" onchange="afficherItems()">Services du campus<br>
        <button onclick="selectAll()">Tout selectionner</button>
        <br>
        <button onclick="resetCouches()">Réinitialiser</button>
    </div>

    <div class="selection">
        <p>Vous êtes :</p>
        <input type="checkbox" class="public-checkbox" value="etudiant" onchange="changePublic('etudiant')">Etudiant<br>
        <input type="checkbox" class="public-checkbox" value="professeur" onchange="changePublic('professeur')">Professeur<br>

        <select id="select-filiere" name="select-filiere" onchange="changeFiliere()">
            <option value="" disabled>Choisissez une filière</option>
        </select>
    </div>

    <div class="selection">
        <select id="select-campus" name="select-campus" onchange="changeCampus()">
            <option value="" disabled>Choisissez un Campus</option>
            <option value="Orleans">Orléans</option>
            <option value="Tours">Tours</option>
        </select>
    </div>
  </div>
    <div class="selection">
    <button onclick="exportCsv()">export CSV</button>
    <br>
    <button id="download" onclick="exportGeojson()">export Geojson</button>
</div>
</div>

</body>
</html>